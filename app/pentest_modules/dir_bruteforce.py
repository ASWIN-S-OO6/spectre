#!/usr/bin/env python3
import subprocess, os, tempfile, requests
from urllib.parse import urljoin


class DirectoryBruteforce:
    def __init__(self, engine):
        self.engine = engine

    def execute(self, target, out):
        if not target.startswith(("http://", "https://")):
            target = f"http://{target}"

        out(f"\r\n{'='*60}\r\n", "#00ff41")
        out(f"[ğŸ”] AI Directory Discovery â€” {target}\r\n", "#00ff41")
        out(f"{'='*60}\r\n\r\n", "#00ff41")

        # Phase 1 â€” fingerprint
        out("[Phase 1] Fingerprinting...\r\n", "#58a6ff")
        tech = ""
        try:
            r = subprocess.run(["whatweb", "--color=never", target],
                               capture_output=True, text=True, timeout=30)
            if r.stdout:
                out(f"  {r.stdout.strip()}\r\n", "#c9d1d9")
                tech = r.stdout
        except Exception:
            out("  whatweb skipped\r\n", "#ffaa00")

        # Phase 2 â€” AI wordlist
        out("\r\n[Phase 2] Generating AI wordlist...\r\n", "#58a6ff")
        wordlist = self.engine.generate_wordlist(target, "directories")
        out(f"[+] Generated {len(wordlist)} paths\r\n", "#00ff41")

        # Phase 3 â€” test
        out("\r\n[Phase 3] Testing paths...\r\n", "#58a6ff")
        found = []
        for i, path in enumerate(wordlist):
            if not path.startswith("/"):
                path = "/" + path
            url = urljoin(target, path)
            try:
                resp = requests.head(url, timeout=5, allow_redirects=False)
                s = resp.status_code
                if s in (200, 201, 301, 302, 307, 308, 401, 403):
                    c = "#00ff41" if s == 200 else "#ffaa00"
                    out(f"  [{s}] {path:<50} Size: {resp.headers.get('Content-Length','?')}\r\n", c)
                    found.append((url, s))
                if (i+1) % 25 == 0:
                    out(f"  ... {i+1}/{len(wordlist)}\r\n", "#888888")
            except Exception:
                continue

        # Phase 4 â€” gobuster
        out("\r\n[Phase 4] Gobuster deep scan...\r\n", "#58a6ff")
        gb = ""
        try:
            with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False) as f:
                f.write("\n".join(wordlist))
                wpath = f.name
            r = subprocess.run(
                ["gobuster", "dir", "-u", target, "-w", wpath, "-t", "20", "-q",
                 "--no-color", "-s", "200,201,204,301,302,307,401,403"],
                capture_output=True, text=True, timeout=120)
            os.unlink(wpath)
            if r.stdout:
                out(r.stdout + "\r\n", "#c9d1d9")
                gb = r.stdout
        except Exception as e:
            out(f"  Gobuster: {e}\r\n", "#ffaa00")

        # Phase 5 â€” analysis
        out("\r\n[Phase 5] AI analysis...\r\n", "#58a6ff")
        results_text = "\n".join(f"FOUND: {u} ({c})" for u, c in found)
        if gb:
            results_text += "\n" + gb
        if results_text.strip():
            a = self.engine.analyze_results("Directory Discovery", results_text, target)
            out(f"\r\n{a}\r\n", "#00d4ff")

        out(f"\r\n{'='*60}\r\n", "#00ff41")
        out(f"[âœ“] Done. Found {len(found)} paths.\r\n\r\n", "#00ff41")
