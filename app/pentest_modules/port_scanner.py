#!/usr/bin/env python3
import subprocess


class PortScanner:
    def __init__(self, engine):
        self.engine = engine

    def execute(self, target, out):
        out(f"\r\n{'='*60}\r\n", "#00ff41")
        out(f"[ðŸ“¡] AI Port Scanner â€” {target}\r\n{'='*60}\r\n\r\n", "#00ff41")

        out("[Phase 1] Quick TCP scan...\r\n", "#58a6ff")
        q = self._nmap(target, ["-sT", "-T4", "--top-ports", "1000"], out)

        ports = [l.split("/")[0].strip() for l in (q or "").split("\n")
                 if "/tcp" in l and "open" in l and l.split("/")[0].strip().isdigit()]

        if ports:
            out(f"\r\n[Phase 2] Service detection on {len(ports)} ports...\r\n", "#58a6ff")
            d = self._nmap(target, ["-sV", "-sC", "-p", ",".join(ports)], out)
        else:
            out("\r\n[Phase 2] No open ports found.\r\n", "#ffaa00")
            d = q

        out("\r\n[Phase 3] AI analysis...\r\n", "#58a6ff")
        a = self.engine.analyze_results("nmap", d or q or "", target)
        out(f"\r\n{a}\r\n", "#00d4ff")

        out(f"\r\n{'='*60}\r\n[âœ“] Scan complete. {len(ports)} open ports.\r\n\r\n", "#00ff41")

    def _nmap(self, target, flags, out):
        cmd = ["nmap"] + flags + [target]
        out(f"[*] {' '.join(cmd)}\r\n", "#888888")
        try:
            r = subprocess.run(cmd, capture_output=True, text=True, timeout=300)
            if r.stdout: out(r.stdout + "\r\n", "#c9d1d9")
            if r.stderr: out(r.stderr + "\r\n", "#ffaa00")
            return r.stdout or ""
        except Exception as e:
            out(f"[!] {e}\r\n", "#ff4444"); return ""
