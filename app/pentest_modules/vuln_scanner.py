#!/usr/bin/env python3
import subprocess


class VulnScanner:
    def __init__(self, engine):
        self.engine = engine

    def execute(self, target, out):
        web = target if target.startswith(("http://","https://")) else f"http://{target}"

        out(f"\r\n{'='*60}\r\n", "#00ff41")
        out(f"[ğŸ›¡ï¸] AI Vuln Scanner â€” {target}\r\n{'='*60}\r\n\r\n", "#00ff41")

        out("[Phase 1] Nmap vuln scripts...\r\n", "#58a6ff")
        n = self._run(["nmap", "-sV", "--script", "vuln", "-T4", target], out)

        out("\r\n[Phase 2] Nikto...\r\n", "#58a6ff")
        k = self._run(["nikto", "-h", web, "-nointeractive"], out)

        out("\r\n[Phase 3] AI analysis...\r\n", "#58a6ff")
        a = self.engine.analyze_results("Vuln Scan", (n + k)[:5000], target)
        out(f"\r\n{a}\r\n", "#00d4ff")

        out(f"\r\n{'='*60}\r\n[âœ“] Vulnerability scan complete.\r\n\r\n", "#00ff41")

    def _run(self, cmd, out):
        out(f"[*] {' '.join(cmd)}\r\n", "#888888")
        try:
            r = subprocess.run(cmd, capture_output=True, text=True, timeout=300)
            if r.stdout: out(r.stdout + "\r\n", "#c9d1d9")
            return r.stdout or ""
        except Exception as e:
            out(f"[!] {e}\r\n", "#ff4444"); return ""
