#!/usr/bin/env python3
import subprocess


class Recon:
    def __init__(self, engine):
        self.engine = engine

    def execute(self, target, out):
        out(f"\r\n{'='*60}\r\n", "#00ff41")
        out(f"[ðŸ”­] AI Recon â€” {target}\r\n{'='*60}\r\n\r\n", "#00ff41")

        info = ""

        out("[Phase 1] DNS / WHOIS...\r\n", "#58a6ff")
        for name, cmd in [("A",["dig","+short","A",target]),("MX",["dig","+short","MX",target]),
                          ("NS",["dig","+short","NS",target]),("WHOIS",["whois",target])]:
            try:
                r = subprocess.run(cmd, capture_output=True, text=True, timeout=15)
                if r.stdout.strip():
                    txt = r.stdout if name != "WHOIS" else "\n".join(r.stdout.split("\n")[:25])
                    out(f"  [{name}] {txt.strip()}\r\n", "#c9d1d9")
                    info += f"\n{name}:\n{r.stdout}\n"
            except Exception: pass

        out("\r\n[Phase 2] AI subdomain discovery...\r\n", "#58a6ff")
        subs = self.engine.generate_wordlist(target, "subdomains")
        out(f"[+] Testing {min(len(subs),50)} subdomains...\r\n", "#00ff41")
        for s in subs[:50]:
            fqdn = f"{s}.{target}"
            try:
                r = subprocess.run(["dig","+short","A",fqdn], capture_output=True, text=True, timeout=5)
                if r.stdout.strip():
                    out(f"  [FOUND] {fqdn} â†’ {r.stdout.strip()}\r\n", "#00ff41")
                    info += f"Subdomain: {fqdn} â†’ {r.stdout.strip()}\n"
            except Exception: pass

        out("\r\n[Phase 3] Quick port scan...\r\n", "#58a6ff")
        try:
            r = subprocess.run(["nmap","-sT","-T4","--top-ports","100",target],
                               capture_output=True, text=True, timeout=120)
            if r.stdout: out(r.stdout+"\r\n","#c9d1d9"); info += r.stdout
        except Exception: pass

        out("\r\n[Phase 4] Web tech...\r\n", "#58a6ff")
        for url in [f"http://{target}", f"https://{target}"]:
            try:
                r = subprocess.run(["whatweb","--color=never",url],
                                   capture_output=True, text=True, timeout=20)
                if r.stdout.strip():
                    out(f"  {r.stdout.strip()}\r\n","#c9d1d9"); info += r.stdout; break
            except Exception: pass

        out("\r\n[Phase 5] AI attack plan...\r\n", "#58a6ff")
        plan = self.engine.ask(
            f"Based on recon for {target}:\n{info[:4000]}\n\n"
            "Create attack plan: surface summary, priority targets, exploitation paths, exact commands."
        )
        out(f"\r\n{plan}\r\n", "#00d4ff")

        out(f"\r\n{'='*60}\r\n[âœ“] Recon complete.\r\n\r\n", "#00ff41")
